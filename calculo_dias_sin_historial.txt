WITH base_trabajadores AS (
    SELECT 
        id,
        nombres,
        fecha_ingreso,
        fecha_reingreso,
		puesto_id,
        COALESCE(fecha_reingreso, fecha_ingreso) AS fecha_base,
        -- Para período 2023-2024 (año calendario 2023)
        EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int AS anios_trabajados,
        CASE
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int <= 0 THEN 0
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int = 1 THEN 12
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int = 2 THEN 14
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int = 3 THEN 16
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int = 4 THEN 18
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int = 5 THEN 20
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int BETWEEN 6 AND 10 THEN 22
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int BETWEEN 11 AND 15 THEN 24
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int BETWEEN 16 AND 20 THEN 26
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int BETWEEN 21 AND 25 THEN 28
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int BETWEEN 26 AND 30 THEN 30
            WHEN EXTRACT(YEAR FROM AGE(DATE '2024-12-31', COALESCE(fecha_reingreso, fecha_ingreso)))::int BETWEEN 31 AND 35 THEN 32
            ELSE 32
        END AS periodoActualDias
    FROM trabajadores 
    WHERE id = 74
),
vacaciones_trabajadores AS (
   SELECT *, 
       (dias_solicitados_total + dias_pend) as pendientes 
  FROM ( 
    SELECT 
        t.id, 11 id_v,
        COALESCE((
            SELECT SUM(dias_totales) 
            FROM vacaciones
            WHERE trabajador_id = t.id
            AND id = 11
        ), 0) as dias_solicitados,
        COALESCE((
            SELECT SUM(dias_totales)
            FROM vacaciones
            WHERE trabajador_id = t.id
            AND periodo_id = 2 
            AND vacaciones_admin_id IS NULL 
            AND id > 11
        ), 0) as dias_solicitados_total, 
        COALESCE((
            SELECT SUM(dias_pendientes) 
            FROM vacaciones_admin 
            WHERE trabajador_id = t.id 
            AND periodo_id = 2 
        ), 0) as dias_pend 
    FROM trabajadores t 
  WHERE id = 74
  ) as subquery 
)
SELECT 
	b.nombres,
	p.puesto,
	b.fecha_ingreso,
	v2.fecha_solicitud,
	CONCAT(v2.fecha_inicio, ' al dia ' , v2.fecha_fin) AS dia,
	v2.dia_laborar,
	CONCAT(pr.periodo, '(',b.periodoActualDias,' dias)') AS dias_periodo,
	v.pendientes,
	v.dias_solicitados,
	b.periodoActualDias - v.dias_solicitados - v.pendientes AS dias_tomados,
	u.nombre
FROM base_trabajadores b
LEFT JOIN vacaciones_trabajadores v ON b.id = v.id
JOIN puestos p ON b.puesto_id = p.id 
JOIN vacaciones v2 ON v.id_v = v2.id
JOIN periodos pr ON v2.periodo_id = pr.id_p
JOIN users u ON u.id = v2.estatus_comite_id 
WHERE b.id = v.id
ORDER BY b.nombres ASC